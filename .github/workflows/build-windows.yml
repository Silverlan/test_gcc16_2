name: Check Windows Build
on:
  push:

env:
  # See https://github.com/git-lfs/git-lfs/issues/5749
  GIT_CLONE_PROTECTION_ACTIVE: 'false'

jobs:
  build:
    name: Build - ${{ matrix.config.os }}
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
          - os: windows-latest
            name: "Windows x64 MSVC"
            artifact: "Windows-MSVC.tar.xz"
            build_type: "RelWithDebInfo"
            environment_script: "C:/Program Files (x86)/Microsoft Visual Studio/2019/Enterprise/VC/Auxiliary/Build/vcvars64.bat"
            cc: "cl"
            cxx: "cl"
            archiver: "7z a"
            generators: "Visual Studio 17 2022"
            build_dir: 'build'
    steps:
      - name: Windows disk diagnostics (PowerShell, accurate C view)
        shell: pwsh
        run: |
          # don't stop on non-terminating errors
          $ErrorActionPreference = 'Continue'

          Write-Output "=== Windows disk diagnostics (Get-Volume + top dirs + large files) ==="
          Write-Output "Time: $(Get-Date -AsUTC -Format 'yyyy-MM-dd HH:mm:ssZ')"

          # Drive summary
          Get-Volume -DriveLetter C | Select-Object DriveLetter, FileSystemLabel, @{N='SizeGB';E={[math]::Round($_.Size/1GB,2)}}, @{N='FreeGB';E={[math]::Round($_.SizeRemaining/1GB,2)}}, @{N='PctFree';E={ if ($_.Size -gt 0) {[math]::Round($_.SizeRemaining/$_.Size*100,1)} else {'N/A'} }} | Format-Table -AutoSize

          Write-Output "`n--- Shadow storage (vss) ---"
          Try { vssadmin list shadowstorage } Catch { Write-Output "vssadmin: failed or not permitted" }

          Write-Output "`n--- pagefile/hiberfile sizes ---"
          Try {
            Get-Item -Path C:\pagefile.sys,C:\hiberfil.sys -ErrorAction SilentlyContinue |
              Select-Object Name, @{N='SizeGB';E={[math]::Round($_.Length/1GB,3)}} |
              Format-Table -AutoSize
          } Catch { Write-Output "pagefile check failed" }

          Write-Output "`n--- System Volume Information size (may require admin) ---"
          Try {
            $s = Get-ChildItem 'C:\System Volume Information' -Force -Recurse -ErrorAction SilentlyContinue |
                Measure-Object -Property Length -Sum
            [PSCustomObject]@{ Path='C:\System Volume Information'; SizeGB = [math]::Round(($s.Sum/1GB),3) } | Format-Table -AutoSize
          } Catch { Write-Output "SVI check failed" }

          Write-Output "`n--- Top directories under C:\\ (one level) by aggregated size ---"
          # Note: this iterates each top-level directory and sums its contents recursively.
          Get-ChildItem -Path C:\ -Force -Directory -ErrorAction SilentlyContinue |
            ForEach-Object {
              $p = $_.FullName
              $sum = (Get-ChildItem -Path $p -Recurse -Force -ErrorAction SilentlyContinue | Where-Object { -not $_.PSIsContainer } | Measure-Object -Property Length -Sum).Sum
              [PSCustomObject]@{ Path = $p; SizeBytes = $sum; SizeGB = [math]::Round($sum/1GB,3) }
            } |
            Sort-Object SizeBytes -Descending | Select-Object -First 30 |
            Format-Table SizeGB, Path -AutoSize

          Write-Output "`n--- Top large files on C: (>=100MB) ---"
          # Streamed to avoid building huge arrays
          Get-ChildItem -Path C:\ -Force -Recurse -ErrorAction SilentlyContinue -File |
            Where-Object { $_.Length -ge 100MB } |
            Select-Object FullName, @{N='SizeMB';E={[math]::Round($_.Length/1MB,2)}} |
            Sort-Object SizeMB -Descending |
            Select-Object -First 50 |
            Format-Table SizeMB, FullName -AutoSize

          Write-Output "`nIf you see large sizes in Pagefile, System Volume Information, or ShadowStorage, those explain the 'missing' 113GB."

