name: Install GCC16 from image onto runner
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure docker works
        run: |
          docker info

      - name: Pull image & export filesystem into /opt/gcc16
        run: |
          set -eux
          IMAGE=ghcr.io/mattkretz/cplusplus-ci/gcc16:latest

          docker pull "$IMAGE"

          # create container (no need to run it), then export its filesystem as a tar
          CID=$(docker create "$IMAGE")
          sudo mkdir -p /opt/gcc16
          # export the container FS and extract under /opt/gcc16
          docker export "$CID" | sudo tar -x -C /opt/gcc16
          docker rm "$CID"

          # Now /opt/gcc16 contains the image's rootfs.  Inspect as needed:
          ls -la /opt/gcc16/usr/bin | head -n 20

      - name: Make extracted toolchain visible to subsequent steps
        run: |
          # add the likely bin dirs to PATH for later steps
          echo "/opt/gcc16/usr/bin" >> $GITHUB_PATH
          echo "/opt/gcc16/bin" >> $GITHUB_PATH

          # add common library dirs to LD_LIBRARY_PATH for dynamic linking
          echo "LD_LIBRARY_PATH=/opt/gcc16/usr/lib:/opt/gcc16/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Check gcc/g++ versions from extracted tree
        run: |
          gcc --version
          g++ --version

      - name: Build (example)
        run: |
          # your build commands here will now use the extracted gcc/g++
          cmake -S . -B build
          cmake --build build -- -j2
