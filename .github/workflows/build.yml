name: Build GCC 16 (Ubuntu runner - 64-bit only)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-gcc:
    runs-on: ubuntu-latest
    env:
      DEBIAN_FRONTEND: noninteractive

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare & build GCC 16 (runner-writable paths, 64-bit only)
        shell: bash
        run: |
          set -euo pipefail
          set -x

          echo "Runner info: $(uname -a)"
          df -h .

          sudo apt-get update

          # Install dependencies (removed 32-bit dev packages to enforce 64-bit-only build)
          sudo apt-get install -y --no-install-recommends \
            autoconf2.69 dwz lzma xz-utils libzstd-dev zlib1g-dev systemtap-sdt-dev \
            binutils:native binutils-hppa64-linux-gnu:native gettext nvptx-tools amdgcn-tools-18 \
            texinfo sharutils procps netbase libisl-dev libmpc-dev libmpfr-dev libgmp-dev

          sudo apt-get clean

          # Use runner-temp & home paths (no /root)
          GCC_ROOT="${RUNNER_TEMP}/gcc-16"         # will contain the gcc source tree
          BINUTILS_ROOT="${RUNNER_TEMP}/binutils" # binutils source tree
          BUILD_OBJ="${GCC_ROOT}/obj"
          GCC_PREFIX="${HOME}/.local/gcc-16"      # install prefix (writable by runner)

          echo "GCC_ROOT = $GCC_ROOT"
          echo "BINUTILS_ROOT = $BINUTILS_ROOT"
          echo "BUILD_OBJ = $BUILD_OBJ"
          echo "GCC_PREFIX = $GCC_PREFIX"

          mkdir -p "$GCC_ROOT" "$BINUTILS_ROOT" "$BUILD_OBJ" "$GCC_PREFIX"

          echo "Downloading GCC source..."
          curl -L https://github.com/gcc-mirror/gcc/archive/master.tar.gz | tar -xz --strip-components=1 -C "$GCC_ROOT"

          echo "Downloading binutils..."
          curl -L https://sourceware.org/pub/binutils/releases/binutils-2.45.tar.gz | tar -xz --strip-components=1 -C "$BINUTILS_ROOT"

          # Create symlinks in the GCC source tree pointing to binutils subdirs (absolute links)
          echo "Linking binutils components into gcc tree..."
          for sub in bfd gas binutils ld libctf libsframe opcodes; do
            if [ -e "$BINUTILS_ROOT/$sub" ]; then
              ln -sfn "$BINUTILS_ROOT/$sub" "$GCC_ROOT/$sub"
            else
              echo "Warning: $BINUTILS_ROOT/$sub not found; skipping link"
            fi
          done

          # Configure & build inside BUILD_OBJ
          cd "$BUILD_OBJ"
          echo "Configuring GCC (64-bit only)..."
          # disable-bootstrap to speed up build; add --disable-multilib to avoid 32-bit requirements
          "$GCC_ROOT/configure" --enable-languages=c,c++,lto --prefix="$GCC_PREFIX" --enable-checking=release --disable-bootstrap --disable-multilib

          echo "Starting make (this can take a very long time)..."
          # Adjust -j value if the runner runs out of memory; 2-4 is typical on hosted runners
          make BOOT_CFLAGS=-march=x86-64-v3 -j3

          echo "Installing into $GCC_PREFIX ..."
          make -j3 install-strip

          # Add installed gcc to PATH for remaining steps in this job (no system-wide alternatives)
          echo "Exporting PATH for this job..."
          echo "$GCC_PREFIX/bin" >> $GITHUB_PATH

          # Clean up sources to save workspace space
          cd "$RUNNER_TEMP"
          rm -rf "$GCC_ROOT" "$BINUTILS_ROOT"

          # Optionally remove heavy build-only dev packages (removed 32-bit dev packages from the purge list)
          sudo apt-get purge --autoremove -y \
            libzstd-dev zlib1g-dev systemtap-sdt-dev \
            libisl-dev libmpc-dev libmpfr-dev libgmp-dev || true

          echo "Done. Installed $GCC_PREFIX/bin/gcc"
          "$GCC_PREFIX/bin/gcc" --version || true

      - name: Test installed GCC is on PATH
        shell: bash
        run: |
          set -euo pipefail
          set -x
          which gcc || true
          gcc --version || true
